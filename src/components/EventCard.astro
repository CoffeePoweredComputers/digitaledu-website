---
/**
 * EventCard Component
 *
 * Displays events in a card format.
 * Supports presentations, reading group, and writing/feedback sessions.
 * Supports both full and compact variants.
 */

type PresentationSubtype = 'talk';
type ReadingGroupSubtype = 'reading';
type WritingFeedbackSubtype = 'writing' | 'feedback';

interface Props {
  type: 'seminar' | 'reading-group' | 'writing-feedback';
  subtype?: PresentationSubtype | ReadingGroupSubtype | WritingFeedbackSubtype;
  title: string;
  date: Date;
  startTime: string;
  endTime: string;
  location?: string;
  // Presentation-specific
  speaker?: {
    name: string;
    affiliation?: string;
  };
  abstract?: string;
  // Reading group-specific
  paper?: {
    title: string;
    authors?: string;
  };
  // Reading group and writing-feedback shared
  facilitator?: string;
  summary?: string;
  // Display options
  href?: string;
  variant?: 'full' | 'compact';
}

const {
  type,
  subtype,
  title,
  date,
  startTime,
  endTime,
  location,
  speaker,
  abstract,
  paper,
  facilitator,
  summary,
  href,
  variant = 'full',
} = Astro.props;

// Get display label based on type and subtype
function getSubtypeLabel(): string {
  if (type === 'seminar') {
    return 'Research Talk';
  }
  if (type === 'reading-group') {
    return 'Paper Discussion';
  }
  // writing-feedback
  switch (subtype) {
    case 'writing': return 'Writing Session';
    case 'feedback': return 'Feedback Session';
    default: return 'Writing & Feedback';
  }
}

// Get badge class based on type and subtype
function getBadgeClass(): string {
  if (type === 'seminar') {
    return 'badge-talk';
  }
  if (type === 'reading-group') {
    return 'badge-paper';
  }
  // writing-feedback type
  return subtype === 'writing' ? 'badge-writing' : 'badge-feedback';
}

const badgeLabel = getSubtypeLabel();
const badgeClass = getBadgeClass();

const dateFormatter = new Intl.DateTimeFormat('en-US', {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const eventDate = new Date(date);
const isoDate = eventDate.toISOString().split('T')[0];
const formattedDate = dateFormatter.format(eventDate);

// Format time for display (convert 24h to 12h)
function formatTime(time: string): string {
  const [hours, minutes] = time.split(':').map(Number);
  const period = hours >= 12 ? 'PM' : 'AM';
  const displayHours = hours % 12 || 12;
  return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
}

const displayTime = `${formatTime(startTime)} - ${formatTime(endTime)} ET`;

// Location display - now handles string location
const isZoomLink = location?.startsWith('http') && location.includes('zoom');
const locationIcon = isZoomLink ? 'ğŸ’»' : 'ğŸ“';
---

<article
  class:list={[
    'bg-white rounded-lg shadow-md border border-grey-200 overflow-hidden',
    'hover:shadow-lg transition-shadow duration-200',
    { 'p-6': variant === 'full', 'p-4': variant === 'compact' }
  ]}
>
  <!-- Type Badge -->
  <div class="flex items-start justify-between gap-4 mb-3">
    <span
      class:list={[
        'inline-block px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wide',
        badgeClass
      ]}
    >
      {badgeLabel}
    </span>
  </div>

  <!-- Title -->
  <h3 class="text-xl font-heading font-semibold mb-2 text-vt-maroon">
    {href ? (
      <a href={href} class="hover:text-vt-impact-orange no-underline">
        {title}
      </a>
    ) : (
      title
    )}
  </h3>

  <!-- Date & Time -->
  <div class="flex flex-wrap gap-4 text-sm text-grey-500 mb-3">
    <time datetime={`${isoDate}T${startTime}`} class="flex items-center gap-1.5">
      <span aria-hidden="true">ğŸ“…</span>
      <span class="sr-only">Date:</span>
      {formattedDate}
    </time>
    <span class="flex items-center gap-1.5">
      <span aria-hidden="true">ğŸ•</span>
      <span class="sr-only">Time:</span>
      {displayTime}
    </span>
    {location && (
      <span class="flex items-center gap-1.5">
        <span aria-hidden="true">{locationIcon}</span>
        <span class="sr-only">Location:</span>
        {isZoomLink ? (
          <a
            href={location}
            class="text-vt-maroon hover:text-vt-impact-orange"
            target="_blank"
            rel="noopener noreferrer"
          >
            Join on Zoom <span class="sr-only">(opens in new tab)</span>
          </a>
        ) : (
          location
        )}
      </span>
    )}
  </div>

  <!-- Speaker (Seminars) -->
  {type === 'seminar' && speaker && (
    <p class="text-sm mb-3">
      <span class="text-grey-500">Presented by:</span>{' '}
      <strong class="text-grey-900">{speaker.name}</strong>
      {speaker.affiliation && (
        <span class="text-grey-500"> ({speaker.affiliation})</span>
      )}
    </p>
  )}

  <!-- Reading Group Details -->
  {type === 'reading-group' && (paper || facilitator || summary) && (
    <div class="text-sm mb-3 bg-grey-50 p-3 rounded-md">
      {paper && (
        <>
          <p class="font-semibold text-grey-900 mb-1">{paper.title}</p>
          {paper.authors && (
            <p class="text-grey-500">{paper.authors}</p>
          )}
        </>
      )}
      {facilitator && (
        <p class={paper ? "mt-2 text-grey-500" : "text-grey-500"}>
          <span>Discussion led by:</span>{' '}
          <strong class="text-grey-900">{facilitator}</strong>
        </p>
      )}
      {summary && !paper && (
        <p class="text-grey-700 mt-2">{summary}</p>
      )}
      {/* Paper Link Button */}
      {paper?.link && (
        <a
          href={paper.link}
          class="inline-block mt-3 bg-vt-maroon text-white px-3 py-1.5 rounded text-xs font-semibold hover:bg-vt-maroon-soft transition-colors no-underline"
          target="_blank"
          rel="noopener noreferrer"
        >
          Read Paper â†’
        </a>
      )}
      {/* Missing Link Warning */}
      {paper && !paper.link && (
        <p class="mt-3 text-amber-600 text-xs flex items-center gap-1">
          <span aria-hidden="true">âš ï¸</span>
          Paper link not yet available
        </p>
      )}
    </div>
  )}

  <!-- Writing & Feedback Session Details -->
  {type === 'writing-feedback' && (facilitator || summary) && (
    <div class="text-sm mb-3 bg-grey-50 p-3 rounded-md">
      {facilitator && (
        <p class="text-grey-500">
          <span>Session led by:</span>{' '}
          <strong class="text-grey-900">{facilitator}</strong>
        </p>
      )}
      {summary && (
        <p class={facilitator ? "text-grey-700 mt-2" : "text-grey-700"}>{summary}</p>
      )}
    </div>
  )}

  <!-- Abstract (Full variant only) -->
  {variant === 'full' && abstract && (
    <p class="text-grey-700 text-sm leading-relaxed line-clamp-3">
      {abstract}
    </p>
  )}

  <!-- View Details Link -->
  {href && variant === 'compact' && (
    <a
      href={href}
      class="inline-block mt-3 text-sm font-semibold text-vt-maroon hover:text-vt-impact-orange"
    >
      View details â†’
    </a>
  )}
</article>
