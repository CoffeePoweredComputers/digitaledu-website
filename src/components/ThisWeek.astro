---
/**
 * ThisWeek Component
 *
 * Hero component showing the current or next upcoming event.
 * Displayed prominently on the homepage.
 * Data pulled from Google Calendar.
 */

import { getUpcomingEvents, type CalendarEvent, getSubtypeLabel } from '../lib/calendar';
import LocalTime from './LocalTime.astro';

// Get upcoming events from calendar
const upcomingEvents = await getUpcomingEvents();

const thisWeekEvent = upcomingEvents[0];
const nextEvent = upcomingEvents[1];

// Get badge class based on type and subtype (matches global.css badge classes)
function getBadgeClass(event: CalendarEvent): string {
  if (event.type === 'seminar') {
    return 'badge-talk';
  }
  if (event.type === 'reading-group') {
    return 'badge-paper';
  }
  // writing-feedback type
  return event.subtype === 'writing' ? 'badge-writing' : 'badge-feedback';
}

// Format date
function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    weekday: 'long',
    month: 'long',
    day: 'numeric',
    year: 'numeric',
  }).format(new Date(date));
}


// Get collection path for event type
function getEventPath(event: CalendarEvent): string {
  if (event.type === 'seminar') return 'seminars';
  if (event.type === 'reading-group') return 'reading-group';
  return 'writing-feedback';
}

// Check if location is a Zoom link
function isZoomLink(location?: string): boolean {
  return location?.startsWith('http') && location.includes('zoom') || false;
}
---

{thisWeekEvent && (
  <section class="bg-vt-maroon-soft text-white py-16">
    <div class="container">
      <div class="max-w-3xl">
        <!-- Section Label -->
        <div class="flex items-center gap-3 mb-5">
          <!-- Decorative vertical accent bar -->
          <span class="flex-shrink-0 w-2 h-8 bg-vt-impact-orange rounded-full" aria-hidden="true"></span>
          <span class="font-semibold uppercase tracking-wider text-lg text-white">
            Up Next at <span class="font-bold">DigitalEd@VT</span>
          </span>
        </div>

        <!-- Event Type Badge -->
        <span
          class:list={[
            'inline-block px-4 py-1.5 rounded-full text-sm font-semibold uppercase tracking-wide mb-4',
            getBadgeClass(thisWeekEvent),
          ]}
        >
          {getSubtypeLabel(thisWeekEvent)}
        </span>

        <!-- Title -->
        <h1 class="text-3xl md:text-4xl font-heading font-bold mb-4 text-white">
          {thisWeekEvent.title}
        </h1>

        <!-- Date, Time, Location -->
        <div class="flex flex-wrap gap-3 mb-6">
          <time
            datetime={`${new Date(thisWeekEvent.date).toISOString().split('T')[0]}T${thisWeekEvent.startTime}`}
            class="inline-flex items-center gap-2 bg-white/15 px-4 py-2 rounded-full text-base"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span class="sr-only">Date:</span>
            {formatDate(thisWeekEvent.date)}
          </time>
          <span class="inline-flex items-center gap-2 bg-white/15 px-4 py-2 rounded-full text-base">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="sr-only">Time:</span>
            <LocalTime
              startDateTime={thisWeekEvent.startDateTime}
              endDateTime={thisWeekEvent.endDateTime}
              startTime={thisWeekEvent.startTime}
              endTime={thisWeekEvent.endTime}
            />
          </span>
        </div>

        <!-- Speaker or Paper Info -->
        {thisWeekEvent.type === 'seminar' && thisWeekEvent.speaker && (
          <p class="text-lg mb-6">
            <span class="text-white/70">Presented by</span>{' '}
            <strong class="text-white">{thisWeekEvent.speaker.name}</strong>
            {thisWeekEvent.speaker.affiliation && (
              <span class="text-white/70"> • {thisWeekEvent.speaker.affiliation}</span>
            )}
          </p>
        )}

        {thisWeekEvent.type === 'reading-group' && thisWeekEvent.paper && (
          <div class="bg-white/10 rounded-lg p-4 mb-6">
            <p class="font-semibold mb-1 text-white">{thisWeekEvent.paper.title}</p>
            {thisWeekEvent.paper.authors && (
              <p class="text-white/70 text-sm">
                {thisWeekEvent.paper.authors}
                {thisWeekEvent.paper.venue && ` • ${thisWeekEvent.paper.venue}`}
              </p>
            )}
          </div>
        )}

        <!-- Location -->
        {thisWeekEvent.location && (
          <div class="mb-8">
            {isZoomLink(thisWeekEvent.location) ? (
              <a
                href={thisWeekEvent.location}
                class="inline-flex items-center gap-2 bg-vt-orange hover:bg-vt-impact-orange text-white px-6 py-3 rounded-lg font-semibold no-underline transition-colors"
                target="_blank"
                rel="noopener noreferrer"
                aria-label="Join this session on Zoom (opens in new tab)"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                Join on Zoom
              </a>
            ) : (
              <span class="inline-flex items-center gap-2 bg-white/15 px-4 py-2 rounded-full text-base">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span class="sr-only">Location:</span>
                {thisWeekEvent.location}
              </span>
            )}
          </div>
        )}

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-4">
          <a
            href={`/${getEventPath(thisWeekEvent)}/${thisWeekEvent.id}/`}
            class="bg-white text-vt-maroon hover:bg-grey-100 px-6 py-3 rounded-lg font-semibold no-underline transition-colors"
          >
            View Details
          </a>
          <a
            href="/calendar/"
            class="border-2 border-white text-white hover:bg-white/10 px-6 py-3 rounded-lg font-semibold no-underline transition-colors"
          >
            Subscribe to Calendar
          </a>
        </div>
      </div>
    </div>
  </section>
)}

<!-- Up Next Preview -->
{nextEvent && (
  <section class="bg-white py-8 border-b border-grey-200">
    <div class="container">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <p class="text-base text-grey-500 uppercase tracking-wider font-semibold mb-1">
            Also Upcoming
          </p>
          <p class="font-heading font-semibold text-vt-maroon text-lg">
            <span
              class:list={[
                'inline-block px-2 py-0.5 rounded text-sm mr-2',
                getBadgeClass(nextEvent),
              ]}
            >
              {getSubtypeLabel(nextEvent)}
            </span>
            {nextEvent.title}
          </p>
          <p class="text-base text-grey-500">
            <LocalTime
              startDateTime={nextEvent.startDateTime}
              endDateTime={nextEvent.endDateTime}
              startTime={nextEvent.startTime}
              endTime={nextEvent.endTime}
              showDate={true}
            />
          </p>
        </div>
        <a
          href={`/${getEventPath(nextEvent)}/${nextEvent.id}/`}
          class="text-base text-vt-maroon hover:text-vt-impact-orange font-semibold"
        >
          View details →
        </a>
      </div>
    </div>
  </section>
)}
