---
/**
 * Presentations Listing Page
 *
 * Shows all research talks from Google Calendar,
 * grouped by upcoming and past.
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import EventCard from '../../components/EventCard.astro';
import { getPresentations } from '../../lib/calendar';

const presentations = await getPresentations();

// Sort by date (newest first for display)
const sortedPresentations = presentations.sort(
  (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()
);

const now = new Date();
const upcomingPresentations = sortedPresentations
  .filter((p) => new Date(p.date) >= now && !p.cancelled)
  .reverse(); // Upcoming should be soonest first

const pastPresentations = sortedPresentations.filter(
  (p) => new Date(p.date) < now || p.cancelled
);

// Group past presentations by semester
function getSemester(date: Date): string {
  const month = date.getMonth();
  const year = date.getFullYear();
  if (month >= 0 && month <= 4) return `Spring ${year}`;
  if (month >= 5 && month <= 7) return `Summer ${year}`;
  return `Fall ${year}`;
}

const pastBySemester = pastPresentations.reduce((acc, presentation) => {
  const semester = getSemester(new Date(presentation.date));
  if (!acc[semester]) acc[semester] = [];
  acc[semester].push(presentation);
  return acc;
}, {} as Record<string, typeof pastPresentations>);
---

<BaseLayout title="Presentations" description="Research talks from the DigitalEd@VT Digital Education group at Virginia Tech.">
  <!-- Header -->
  <section class="bg-vt-maroon-soft text-white py-12">
    <div class="container">
      <h1 class="text-3xl md:text-4xl font-heading font-bold mb-4 text-white">
        Presentations
      </h1>
      <p class="text-lg text-white/80 max-w-2xl">
        Research talks exploring how technology transforms teaching
        and learning across disciplines.
      </p>
    </div>
  </section>

  <!-- Upcoming Presentations -->
  <section class="section">
    <div class="container">
      <h2 class="text-2xl font-heading font-bold mb-6 text-vt-maroon">Upcoming</h2>

      {upcomingPresentations.length > 0 ? (
        <div class="grid md:grid-cols-2 gap-6">
          {upcomingPresentations.map((presentation) => (
            <EventCard
              type="seminar"
              subtype={presentation.subtype}
              title={presentation.title}
              date={presentation.date}
              startTime={presentation.startTime}
              endTime={presentation.endTime}
              location={presentation.location}
              speaker={presentation.speaker}
              abstract={presentation.abstract}
              href={`/seminars/${presentation.id}/`}
              variant="full"
            />
          ))}
        </div>
      ) : (
        <div class="bg-grey-50 rounded-lg p-8 text-center">
          <p class="text-grey-500 text-lg mb-4">No upcoming presentations scheduled.</p>
          <a
            href="/calendar/"
            class="text-vt-maroon hover:text-vt-impact-orange font-semibold"
          >
            Subscribe to be notified of future events â†’
          </a>
        </div>
      )}
    </div>
  </section>

  <!-- Past Presentations -->
  {Object.keys(pastBySemester).length > 0 && (
    <section class="section bg-grey-50">
      <div class="container">
        <h2 class="text-2xl font-heading font-bold mb-6 text-vt-maroon">Past Presentations</h2>

        {Object.entries(pastBySemester).map(([semester, presentations]) => (
          <div class="mb-8">
            <h3 class="text-lg font-heading font-semibold text-grey-500 mb-4">
              {semester}
            </h3>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
              {presentations.map((presentation) => (
                <EventCard
                  type="seminar"
                  subtype={presentation.subtype}
                  title={presentation.title}
                  date={presentation.date}
                  startTime={presentation.startTime}
                  endTime={presentation.endTime}
                  location={presentation.location}
                  speaker={presentation.speaker}
                  href={`/seminars/${presentation.id}/`}
                  variant="compact"
                />
              ))}
            </div>
          </div>
        ))}
      </div>
    </section>
  )}
</BaseLayout>
